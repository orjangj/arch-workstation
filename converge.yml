# vim: set ft=yaml.ansible:
---
- name: Workstation playbook
  hosts: all

  vars_files:
    - config.yml

  pre_tasks:
    # {{{ Pre-tasks
    - name: Arch - Update package cache
      become: yes
      community.general.pacman:
        update_cache: yes
      tags: [always]
      when: ansible_os_family == 'Archlinux'

    - name: Debian - Update package cache
      become: yes
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3000
      tags: [always]
      when: ansible_os_family == 'Debian'

    - name: Fedora - Update package cache
      become: yes
      ansible.builtin.dnf:
        state: present
        update_cache: yes
      tags: [always]
      when: ansible_distribution == 'Fedora'
  # }}}
  roles:
    - { role: system, tags: [system] }
    - { role: xorg, tags: [xorg], when: display_server == 'xorg' or 'xorg' in ansible_run_tags }
    - { role: sddm, tags: [sddm, dm], when: display_manager == 'sddm' or 'sddm' in ansible_run_tags }
    - { role: awesome, tags: [awesome, wm], when: window_manager == 'awesome' or 'awesome' in ansible_run_tags }
    - { role: qtile, tags: [qtile, wm], when: window_manager == 'qtile' or 'qtile' in ansible_run_tags }
    - { role: sway, tags: [sway, wm], when: window_manager == 'sway' or 'sway' in ansible_run_tags }
    - { role: dotfiles, tags: [dotfiles] }
    - { role: alacritty, tags: [alacritty, terminal], when: terminal == 'alacritty' or 'alacritty' in ansible_run_tags }
    - { role: kitty, tags: [kitty, terminal], when: terminal == 'kitty' or 'kitty' in ansible_run_tags }
    - { role: foot, tags: [foot, terminal], when: terminal == 'foot' or 'foot' in ansible_run_tags }
    - { role: neovim, tags: [neovim, editor], when: editor == 'neovim' or 'neovim' in ansible_run_tags }
    #- { role: vscode, tags: [vscode, editor], when: editor == 'vscode' or 'vscode' in ansible_run_tags }
    - { role: wallpaper, tags: [wallpaper] }
    - { role: stylua, tags: [stylua, neovim] }
    - { role: lazygit, tags: [lazygit, neovim] }

    # TODO:
    # - ansible_usr_id/dir vs owner: etc...
    # - Make arch, fedora and debian work...
    # - Rename repo to "workstation"
    # - fix qtile for wayland -- separate x11 and wayland
    # - pip packages in config.yml
    # - dotfiles: compton --> picom... awesome wm... xinitrc?
    # - startx -- bash_profile (or .profile)

  tasks:
    - name: Clone git projects
      ansible.builtin.git:
        repo: "{{ item }}"
        depth: 1
        dest: "{{ ansible_user_dir }}/projects/git/{{ item | basename }}"
        version: "master"
        update: false
      with_items:
        - "git@github.com:orjangj/ansible-collection-editors.git"
        - "git@github.com:orjangj/ansible-collection-virtualization.git"
        - "git@github.com:orjangj/cookbook.git"
        - "git@github.com:orjangj/neotest-ctest.git"
        - "git@github.com:orjangj/polar.nvim.git"
      tags: [projects]

    - name: Ensure local fonts directory exists
      ansible.builtin.file:
        state: directory
        mode: "01775"
        path: "{{ ansible_user_dir }}/.local/share/fonts"
      tags: [nerdfonts]

    - name: Install nerdfonts
      ansible.builtin.unarchive:
        src: "https://github.com/ryanoasis/nerd-fonts/releases/download/v2.3.3/{{ item }}.zip"
        dest: "{{ ansible_user_dir }}/.local/share/fonts"
        remote_src: true
      with_items:
        - FiraCode
        - FiraMono
        - Hack
        - Noto
        - Ubuntu
        - UbuntuMono
      tags: [nerdfonts]

    - name: Ensure local themes directory exists
      ansible.builtin.file:
        state: directory
        mode: "01775"
        path: "{{ ansible_user_dir }}/.themes"
      tags: [gtk]

    - name: Install GTK themes
      ansible.builtin.unarchive:
        src: "{{ item }}"
        dest: "{{ ansible_user_dir }}/.themes"
        remote_src: true
      with_items:
        - "https://github.com/EliverLara/Nordic/releases/download/v2.2.0/Nordic-darker.tar.xz"
      tags: [gtk]
