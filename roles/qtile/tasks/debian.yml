---
- name: "Ensure package dependencies are installed (X11)"
  become: yes
  ansible.builtin.package:
    name:
      - xserver-xorg
      - xinit
      - python3
      - python3-pip
      - python3-xcffib  # Must be installed before cffi
      - python3-cffi
      - python3-cairocffi
      - libpangocairo-1.0-0
      #      - "{{ qtile_extra_packages }}"
      - x11-xserver-utils
      - aptitude  # Used by CheckUpdates widget
      - lm-sensors  # Used by ThermalSensor widget
      - brightnessctl  # Used by Brightness widget
      - picom
      - alsa  # For volume control
  when: qtile_backend == "all" or qtile_backend == "x11"

- name: "Install Qtile (X11)"
  ansible.builtin.pip:
    name:
      - dbus-next
      - qtile
      #- "{{ qtile_extra_pip_modules }}"
      - psutil  # For widgets
  when: qtile_backend == "all" or qtile_backend == "x11"

- name: "Ensure package dependencies are installed (Wayland)"
  become: yes
  ansible.builtin.package:
    name:
      - python3
      - python3-pip
      - python3-dev  # pywayland dep
      - libwayland-dev  # pywayland dep
      - libwlroots-dev
      - libxkbcommon-dev  # is this the right one for pywlroots?
      - python3-cffi
      - python3-cairocffi
      - libpangocairo-1.0-0
      #- "{{ qtile_extra_packages }}"
  when: qtile_backend == "all" or qtile_backend == "wayland"

- name: "Install Qtile (Wayland)"
  ansible.builtin.pip:
    name:
      - dbus-next
      - pywayland
      - pywlroots
      - xkbcommon
      - qtile
      #- "{{ qtile_extra_pip_modules }}"
  when: qtile_backend == "all" or qtile_backend == "wayland"

- name: "Ensure xsessions directory exist"
  become: yes
  ansible.builtin.file:
    state: directory
    path: /usr/share/xsessions
  when: qtile_desktop_entry

- name: "Ensure desktop entry is installed"
  become: yes
  ansible.builtin.copy:
    src: qtile.desktop
    dest: /usr/share/xsessions/qtile.desktop
  when: qtile_desktop_entry 
